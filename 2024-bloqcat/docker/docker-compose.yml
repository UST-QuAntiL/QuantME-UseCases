version: '3.6'
volumes:
  exec_data:
  pgdata:
  keycloak_pgdata:
services:
  bloqCat-api:
    image: aldekal/bloqcat-api:bloqcat
    ports:
      - "5000:5000"
    networks:
      - bloqcat-tutorial
  ##### Winery ###
  winery:
    image: aldekal/winery:bloqcat
    environment:
      WINERY_HOSTNAME: ${PUBLIC_HOSTNAME}
      WORKFLOWMODELER_HOSTNAME: ${PUBLIC_HOSTNAME}
      TOPOLOGYMODELER_HOSTNAME: ${PUBLIC_HOSTNAME}
      CONTAINER_HOSTNAME: ${PUBLIC_HOSTNAME}
      WINERY_REPOSITORY_URL: https://github.com/aldekal/bloqCat-modeling
    ports:
      - '8080:8080'
    networks:
      - bloqcat-tutorial
  # database qc-atlas and pattern-atlas
  # each container has it's own database, generated by the db image
  db:
    build:
      context: ./db
    image: bloqcat-db
    environment:
      # specifies user:pw for each container
      POSTGRES_USERS: 'planqk:planqk|patternatlas:patternatlas'
      # specifies db name for each container
      POSTGRES_DATABASES: 'planqk:planqk|patternatlas:patternatlas'
      ATLAS_DB: planqk
      PATTERNATLAS_DB: patternatlas
    #volumes:
      # use this volume to save the postgres data
      # - ./postgres-data:/var/lib/postgresql/data
    ports:
      - '5060:5060'
    networks:
      - bloqcat-tutorial
  qc-atlas-ui:
    image: aldekal/qc-atlas-ui:bloqcat
    depends_on:
      - config-server
    environment:
      # because the requests are performed from the browser and not
      # from the container itself we have to specify localhost here
      # and **not** the container name
      QC_ATLAS_HOST_NAME: localhost
      QC_ATLAS_PORT: 6626
      PATTERN_ATLAS_HOST_NAME: localhost
      PATTERN_ATLAS_PORT: 1977
      PATTERN_ATLAS_UI_HOST_NAME: localhost
      PATTERN_ATLAS_UI_PORT: 1978
      NISQ_ANALYZER_HOST_NAME: localhost
      NISQ_ANALYZER_PORT: 5010
      QPROV_HOST_NAME: localhost
      QPROV_PORT: 5020
      LATEX_RENDERER_HOST_NAME: localhost
      LATEX_RENDERER_PORT: 5030
    ports:
      - '80:80'
    volumes:
      - ./config:/opt/init-config.d
    networks:
      - bloqcat-tutorial
  qc-atlas-api:
    image: aldekal/qc-atlas-api:bloqcat
    volumes:
      # use this volume to save the concrete solution files
      - /home/aldekal/Documents/github/qc-atlas-content/concrete_solutions:/opt/tomcat/temp/qc-atlas
    environment:
      POSTGRES_HOSTNAME: db
      POSTGRES_PORT: 5060
      POSTGRES_USER: planqk
      POSTGRES_PASSWORD: planqk
      POSTGRES_DB: planqk
    ports:
      - "6626:6626"
    networks:
      - bloqcat-tutorial
  pattern-atlas-api:
    image: patternatlas/pattern-atlas-api:v1.8.4
    environment:
      JDBC_DATABASE_URL: db
      JDBC_DATABASE_USERNAME: patternatlas
      JDBC_DATABASE_PASSWORD: patternatlas
      JDBC_DATABASE_PORT: 5060
      DB_INIT_USER: patternatlas
      DB_INIT_PASSWORD: patternatlas
      LATEX_RENDERER_HOST_NAME: latex-renderer
      LATEX_RENDERER_PORT: 5030
      JDBC_DATABASE_NAME: patternatlas
      PATTERN_ATLAS_FETCH_INITIAL_DATA: 'true'
      HAL_EXPLORER: 'false'
      #PATTERN_ATLAS_CONTENT_REPOSITORY_BRANCH: feature/known_uses
      # activate correct application properties
      SPRING_PROFILES_ACTIVE: docker
      JWK_URI: http://auth:8080/realms/patternatlas/protocol/openid-connect/certs
      SECURITY_LOGLEVEL: info
    ports:
      - "1977:1977"
    networks:
      - bloqcat-tutorial
    depends_on:
      - db
      - latex-renderer
  pattern-atlas-ui:
    image: patternatlas/pattern-atlas-ui:v1.5.6
    depends_on:
      - config-server
    environment:
      # because the requests are performed from the browser and not
      # from the container itself we have to specify localhost here
      # and **not** the container name
      PATTERN_ATLAS_API_HOST_NAME: localhost
      PATTERN_ATLAS_API_PORT: 1977
      LATEX_RENDERER_HOST_NAME: localhost
      LATEX_RENDERER_PORT: 5030
      URL_SCHEME: http
      AUTH_REALM_URL: http://localhost:7080/realms/patternatlas
    ports:
      - "1978:80"
    networks:
      - bloqcat-tutorial
  auth:
    image: quay.io/keycloak/keycloak:18.0.0
    command: start-dev --import-realm
    volumes:
      - ./keycloak_import:/opt/keycloak/data/import
    environment:
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_ADMIN: admin
    ports:
      - "7080:8080"
    networks:
      - bloqcat-tutorial
  # used by qc-atlas-ui to render latex
  latex-renderer:
    image: planqk/latex-renderer:v1.2.0
    ports:
      - "5030:5030"
  config-server:
    image: quay.io/coreos/etcd:latest
    environment:
      ETCD_NAME: config-node1
      ETCD_CORS: "*"
      ETCD_ADVERTISE_CLIENT_URLS: "http://config-server:2379"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCDCTL_API: 3
    ports:
      - "2379:2379"
    networks:
      - bloqcat-tutorial
# sequenc components
  qunicorn:
      image: "iaasgeorgdl/qunicorn:release.11.23"
      networks:
        - bloqcat-tutorial
      environment:
        CONTAINER_MODE: server
        SERVER_PORT: 5005
        BROKER_URL: "redis://broker:6379"
        DB_URL: "postgresql://postgres:passwd@postgres/qunicorn"
        JWKS_URL: "http://keycloak:8081/auth/realms/qunicorn/protocol/openid-connect/certs"
        NUMBA_CACHE_DIR: "/app/cache"
      depends_on:
        - postgres
        - broker
        - worker
      ports:
        - "5005:5005"
  worker:
    image: "iaasgeorgdl/qunicorn:release.11.23"
    networks:
      - bloqcat-tutorial
    environment:
      CONTAINER_MODE: worker
      BROKER_URL: "redis://broker:6379"
      DB_URL: "postgresql://postgres:passwd@postgres/qunicorn"
      NUMBA_CACHE_DIR: "/app/cache"
    depends_on:
      - postgres
      - broker
    ports:
      - "6379"
  # postgres container for the database for Qunicorn jobs and deployments
  postgres:
    image: postgres:15.3
    networks:
      - bloqcat-tutorial
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_PASSWORD: passwd
      POSTGRES_DB: qunicorn
    volumes:
      - pgdata:/var/lib/postgresql/data \
    ports:
      - "5432:5432"
  # Broker for the Celery (Pilot-Job) setup 
  broker:
    image: redis:7.0.12
    networks:
      - bloqcat-tutorial
    ports:
      - "6379:6379"
networks:
  bloqcat-tutorial:
    driver: bridge